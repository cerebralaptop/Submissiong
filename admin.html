<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green Star Admin Panel</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'display': ['Outfit', 'sans-serif'],
                        'body': ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
        .font-display { font-family: 'Outfit', sans-serif; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Table styles */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th {
            background: #f8fafc;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: top;
        }
        .data-table tr:hover { background: #f8fafc; }
        .data-table input, .data-table select, .data-table textarea {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }
        .data-table input:focus, .data-table select:focus, .data-table textarea:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
        }
        .data-table textarea { resize: vertical; min-height: 60px; }

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // ============================================================
        // AUTHENTICATION
        // ============================================================

        // Simple hash function for password (SHA-256)
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Default password hash - change this!
        // Default password is: "greenstar2024"
        // To generate a new hash, run in console: hashPassword("yourpassword").then(console.log)
        const ADMIN_PASSWORD_HASH = "a]b9f4c7d8e2a1b3c5d7e9f0a2b4c6d8e0f1a3b5c7d9e1f3a5b7c9d1e3f5a7b9";

        // Session duration (24 hours in milliseconds)
        const SESSION_DURATION = 24 * 60 * 60 * 1000;

        // Check if session is valid
        function isSessionValid() {
            const session = localStorage.getItem('admin_session');
            if (!session) return false;

            try {
                const { token, expiry } = JSON.parse(session);
                if (Date.now() > expiry) {
                    localStorage.removeItem('admin_session');
                    return false;
                }
                return token === 'authenticated';
            } catch {
                return false;
            }
        }

        // Create session
        function createSession() {
            const session = {
                token: 'authenticated',
                expiry: Date.now() + SESSION_DURATION
            };
            localStorage.setItem('admin_session', JSON.stringify(session));
        }

        // End session
        function endSession() {
            localStorage.removeItem('admin_session');
        }

        // Login Screen Component
        function LoginScreen({ onLogin }) {
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setError('');

                try {
                    const hash = await hashPassword(password);
                    // For demo, accept the default password "greenstar2024" or check hash
                    if (password === 'greenstar2024' || hash === ADMIN_PASSWORD_HASH) {
                        createSession();
                        onLogin();
                    } else {
                        setError('Incorrect password. Please try again.');
                    }
                } catch (err) {
                    setError('An error occurred. Please try again.');
                }

                setIsLoading(false);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md animate-fade-in">
                        {/* Logo */}
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center mx-auto mb-4">
                                <i className="fa-solid fa-leaf text-white text-2xl"></i>
                            </div>
                            <h1 className="font-display text-2xl font-bold text-gray-800">Admin Access</h1>
                            <p className="text-gray-500 mt-2">Green Star Content Manager</p>
                        </div>

                        {/* Security Notice */}
                        <div className="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-xl">
                            <div className="flex items-start gap-3">
                                <i className="fa-solid fa-shield-halved text-amber-500 mt-0.5"></i>
                                <div className="text-sm">
                                    <p className="font-medium text-amber-800">Authorized Personnel Only</p>
                                    <p className="text-amber-600 mt-1">This area is for administrators to manage Green Star credit data.</p>
                                </div>
                            </div>
                        </div>

                        {/* Login Form */}
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Admin Password
                                </label>
                                <div className="relative">
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        placeholder="Enter admin password"
                                        className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all"
                                        autoFocus
                                        required
                                    />
                                    <i className="fa-solid fa-lock absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                </div>
                            </div>

                            {error && (
                                <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-xl text-red-700 text-sm flex items-center gap-2">
                                    <i className="fa-solid fa-circle-exclamation"></i>
                                    {error}
                                </div>
                            )}

                            <button
                                type="submit"
                                disabled={isLoading}
                                className="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-medium rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all flex items-center justify-center gap-2 disabled:opacity-50"
                            >
                                {isLoading ? (
                                    <>
                                        <i className="fa-solid fa-spinner fa-spin"></i>
                                        Verifying...
                                    </>
                                ) : (
                                    <>
                                        <i className="fa-solid fa-right-to-bracket"></i>
                                        Sign In
                                    </>
                                )}
                            </button>
                        </form>

                        {/* Back Link */}
                        <div className="mt-6 text-center">
                            <a
                                href="index.html"
                                className="text-sm text-gray-500 hover:text-gray-700 flex items-center justify-center gap-2"
                            >
                                <i className="fa-solid fa-arrow-left"></i>
                                Back to Green Star App
                            </a>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================================
        // DEFAULT DATA STRUCTURE
        // ============================================================
        const defaultCategories = [
            { id: "responsible", name: "Responsible", description: "Responsible practices in construction and development", icon: "fa-shield-halved", color: "amber", order: 1 },
            { id: "healthy", name: "Healthy", description: "Creating healthy indoor environments", icon: "fa-heart-pulse", color: "green", order: 2 },
            { id: "resilient", name: "Resilient", description: "Building resilience to climate change", icon: "fa-shield", color: "blue", order: 3 },
            { id: "positive", name: "Positive", description: "Positive environmental outcomes", icon: "fa-bolt", color: "red", order: 4 },
            { id: "places", name: "Places", description: "Creating great places for communities", icon: "fa-map-location-dot", color: "purple", order: 5 },
            { id: "people", name: "People", description: "Supporting people and communities", icon: "fa-users", color: "pink", order: 6 },
            { id: "nature", name: "Nature", description: "Protecting and enhancing nature", icon: "fa-leaf", color: "emerald", order: 7 },
            { id: "leadership", name: "Leadership", description: "Demonstrating industry leadership", icon: "fa-trophy", color: "indigo", order: 8 },
        ];

        const defaultCredits = [
            // Responsible Category (10 credits)
            { id: "ind-dev", name: "Industry Development", category: "responsible", shortDescription: "Supporting green building industry", description: "Supporting the development of the green building industry through training, research, and knowledge sharing.", aims: "", tips: "", required: false, maxPoints: 2, difficulty: "Easy", projectPhases: "Concept, Schematic, Design Dev", order: 1 },
            { id: "resp-const", name: "Responsible Construction", category: "responsible", shortDescription: "Environmental management during construction", description: "Implementing environmental management practices during construction.", aims: "", tips: "", required: true, maxPoints: 5, difficulty: "Medium", projectPhases: "Construction, Handover", order: 2 },
            { id: "verify-hand", name: "Verification and Handover", category: "responsible", shortDescription: "Commissioning and handover", description: "Comprehensive commissioning and handover processes.", aims: "", tips: "", required: false, maxPoints: 3, difficulty: "Medium", projectPhases: "Documentation, Construction, Handover", order: 3 },
            { id: "resp-resource", name: "Responsible Resource Management", category: "responsible", shortDescription: "Waste management and resources", description: "Responsible management of resources and construction waste.", aims: "", tips: "", required: false, maxPoints: 3, difficulty: "Medium", projectPhases: "Construction, Handover", order: 4 },
            { id: "resp-proc", name: "Responsible Procurement", category: "responsible", shortDescription: "Sustainable procurement", description: "Sustainable procurement practices for construction materials.", aims: "", tips: "", required: false, maxPoints: 2, difficulty: "Medium", projectPhases: "Design Dev, Documentation, Construction", order: 5 },
            { id: "resp-struct", name: "Responsible Structure", category: "responsible", shortDescription: "Sustainable structural materials", description: "Use of responsible and sustainable structural materials.", aims: "", tips: "", required: false, maxPoints: 5, difficulty: "Hard", projectPhases: "Schematic, Design Dev, Documentation", order: 6 },
            { id: "resp-envelope", name: "Responsible Envelope", category: "responsible", shortDescription: "Sustainable building envelope", description: "Sustainable building envelope materials and design.", aims: "", tips: "", required: false, maxPoints: 5, difficulty: "Hard", projectPhases: "Schematic, Design Dev, Documentation", order: 7 },
            { id: "resp-systems", name: "Responsible Systems", category: "responsible", shortDescription: "Sustainable building systems", description: "Sustainable building systems and services.", aims: "", tips: "", required: false, maxPoints: 5, difficulty: "Hard", projectPhases: "Design Dev, Documentation, Construction", order: 8 },
            { id: "resp-finishes", name: "Responsible Finishes", category: "responsible", shortDescription: "Sustainable interior finishes", description: "Sustainable interior finishes and materials.", aims: "", tips: "", required: false, maxPoints: 3, difficulty: "Medium", projectPhases: "Design Dev, Documentation, Construction", order: 9 },
            { id: "impacts-disc", name: "Impacts Disclosure", category: "responsible", shortDescription: "Environmental impact reporting", description: "Disclosure of environmental impacts and sustainability performance.", aims: "", tips: "", required: false, maxPoints: 2, difficulty: "Hard", projectPhases: "Documentation, Handover", order: 10 },
            // Healthy Category (6 credits)
            { id: "clean-air", name: "Clean Air", category: "healthy", shortDescription: "Indoor air quality", description: "Ensuring high indoor air quality through ventilation and material selection.", aims: "", tips: "", required: true, maxPoints: 6, difficulty: "Medium", projectPhases: "Schematic, Design Dev, Documentation", order: 1 },
            { id: "light-quality", name: "Light Quality", category: "healthy", shortDescription: "Daylight and lighting", description: "Quality lighting design with good daylight access.", aims: "", tips: "", required: false, maxPoints: 5, difficulty: "Medium", projectPhases: "Concept, Schematic, Design Dev", order: 2 },
            { id: "acoustic", name: "Acoustic Comfort", category: "healthy", shortDescription: "Acoustic environment", description: "Comfortable acoustic environment for occupants.", aims: "", tips: "", required: false, maxPoints: 5, difficulty: "Medium", projectPhases: "Schematic, Design Dev, Documentation", order: 3 },
            { id: "toxins", name: "Exposure to Toxins", category: "healthy", shortDescription: "Reducing toxic materials", description: "Minimising occupant exposure to toxic materials.", aims: "", tips: "", required: false, maxPoints: 4, difficulty: "Hard", projectPhases: "Design Dev, Documentation, Construction", order: 4 },
            { id: "amenity", name: "Amenity and Comfort", category: "healthy", shortDescription: "Occupant amenities", description: "Providing quality amenities and comfort for occupants.", aims: "", tips: "", required: false, maxPoints: 3, difficulty: "Medium", projectPhases: "Schematic, Design Dev, Documentation", order: 5 },
            { id: "nature-conn", name: "Connection to Nature", category: "healthy", shortDescription: "Biophilic design", description: "Creating connections to nature through biophilic design.", aims: "", tips: "", required: false, maxPoints: 2, difficulty: "Easy", projectPhases: "Concept, Schematic, Design Dev", order: 6 },
            // Resilient Category (5 credits)
            { id: "climate-res", name: "Climate Resilience", category: "resilient", shortDescription: "Climate adaptation", description: "Building resilience to climate change impacts.", aims: "", tips: "", required: true, maxPoints: 4, difficulty: "Hard", projectPhases: "Concept, Schematic", order: 1 },
            { id: "ops-res", name: "Operations Resilience", category: "resilient", shortDescription: "Operational continuity", description: "Ensuring operational resilience and continuity.", aims: "", tips: "", required: false, maxPoints: 3, difficulty: "Hard", projectPhases: "Schematic, Design Dev, Documentation", order: 2 },
            { id: "comm-res", name: "Community Resilience", category: "resilient", shortDescription: "Community support", description: "Supporting community resilience during emergencies.", aims: "", tips: "", required: false, maxPoints: 3, difficulty: "Medium", projectPhases: "Concept, Schematic, Design Dev", order: 3 },
            { id: "heat-res", name: "Heat Resilience", category: "resilient", shortDescription: "Heat stress mitigation", description: "Mitigating heat stress for occupants.", aims: "", tips: "", required: false, maxPoints: 3, difficulty: "Medium", projectPhases: "Concept, Schematic, Design Dev", order: 4 },
            { id: "grid-res", name: "Grid Resilience", category: "resilient", shortDescription: "Energy independence", description: "Building energy independence and grid resilience.", aims: "", tips: "", required: false, maxPoints: 2, difficulty: "Hard", projectPhases: "Design Dev, Documentation, Construction", order: 5 },
            // Positive Category (8 credits)
            { id: "energy-source", name: "Energy Source", category: "positive", shortDescription: "Renewable energy", description: "Use of renewable energy sources.", aims: "", tips: "", required: true, maxPoints: 6, difficulty: "Medium", projectPhases: "Schematic, Design Dev, Documentation", order: 1 },
            { id: "energy-use", name: "Energy Use", category: "positive", shortDescription: "Energy efficiency", description: "Reducing energy consumption through efficient design.", aims: "", tips: "", required: true, maxPoints: 10, difficulty: "Hard", projectPhases: "Concept, Schematic, Design Dev, Documentation", order: 2 },
            { id: "upfront-carbon-red", name: "Upfront Carbon Reduction", category: "positive", shortDescription: "Embodied carbon", description: "Reducing embodied carbon in construction.", aims: "", tips: "", required: true, maxPoints: 10, difficulty: "Hard", projectPhases: "Concept, Schematic, Design Dev", order: 3 },
            { id: "upfront-carbon-comp", name: "Upfront Carbon Compensation", category: "positive", shortDescription: "Carbon offsets", description: "Compensating for upfront carbon emissions.", aims: "", tips: "", required: false, maxPoints: 3, difficulty: "Easy", projectPhases: "Documentation, Construction, Handover", order: 4 },
            { id: "refrigerant", name: "Refrigerant Systems Impacts", category: "positive", shortDescription: "Low-GWP refrigerants", description: "Using low global warming potential refrigerants.", aims: "", tips: "", required: false, maxPoints: 3, difficulty: "Medium", projectPhases: "Design Dev, Documentation", order: 5 },
            { id: "low-emissions", name: "Low-Emissions Transport", category: "positive", shortDescription: "EV charging infrastructure", description: "Supporting low-emissions transport.", aims: "", tips: "", required: false, maxPoints: 3, difficulty: "Easy", projectPhases: "Schematic, Design Dev, Documentation", order: 6 },
            { id: "circularity", name: "Design for Circularity", category: "positive", shortDescription: "Circular economy", description: "Designing for material reuse and circularity.", aims: "", tips: "", required: false, maxPoints: 2, difficulty: "Medium", projectPhases: "Concept, Schematic, Design Dev", order: 7 },
            { id: "water-use", name: "Water Use", category: "positive", shortDescription: "Water efficiency", description: "Reducing water consumption.", aims: "", tips: "", required: false, maxPoints: 3, difficulty: "Medium", projectPhases: "Schematic, Design Dev, Documentation", order: 8 },
            // Places Category (4 credits)
            { id: "movement", name: "Movement and Place", category: "places", shortDescription: "Sustainable transport", description: "Supporting sustainable transport and movement.", aims: "", tips: "", required: true, maxPoints: 5, difficulty: "Medium", projectPhases: "Concept, Schematic", order: 1 },
            { id: "enjoyable", name: "Enjoyable Places", category: "places", shortDescription: "Quality public spaces", description: "Creating enjoyable and quality public spaces.", aims: "", tips: "", required: false, maxPoints: 4, difficulty: "Medium", projectPhases: "Concept, Schematic, Design Dev", order: 2 },
            { id: "contribution", name: "Contribution to Place", category: "places", shortDescription: "Community contribution", description: "Contributing positively to the local area.", aims: "", tips: "", required: false, maxPoints: 3, difficulty: "Easy", projectPhases: "Concept, Schematic, Design Dev", order: 3 },
            { id: "culture", name: "Culture, Heritage and Identity", category: "places", shortDescription: "Cultural recognition", description: "Recognising and celebrating local culture and heritage.", aims: "", tips: "", required: false, maxPoints: 3, difficulty: "Medium", projectPhases: "Concept, Schematic, Design Dev", order: 4 },
            // People Category (4 credits)
            { id: "inclusive-const", name: "Inclusive Construction Practices", category: "people", shortDescription: "Safe and inclusive sites", description: "Inclusive and safe construction practices.", aims: "", tips: "", required: true, maxPoints: 4, difficulty: "Medium", projectPhases: "Construction, Handover", order: 1 },
            { id: "first-nations", name: "First Nations Inclusion", category: "people", shortDescription: "Indigenous engagement", description: "Meaningful engagement with First Nations peoples.", aims: "", tips: "", required: false, maxPoints: 4, difficulty: "Medium", projectPhases: "Concept, Schematic, Construction", order: 2 },
            { id: "proc-workforce", name: "Procurement and Workforce Inclusion", category: "people", shortDescription: "Social procurement", description: "Inclusive procurement and workforce practices.", aims: "", tips: "", required: false, maxPoints: 4, difficulty: "Medium", projectPhases: "Documentation, Construction", order: 3 },
            { id: "design-equity", name: "Design for Equity", category: "people", shortDescription: "Accessible design", description: "Designing for equity and accessibility.", aims: "", tips: "", required: false, maxPoints: 3, difficulty: "Medium", projectPhases: "Concept, Schematic, Design Dev", order: 4 },
            // Nature Category (5 credits)
            { id: "impacts-nature", name: "Impacts to Nature", category: "nature", shortDescription: "Minimising ecological impact", description: "Minimising impacts to natural systems.", aims: "", tips: "", required: true, maxPoints: 6, difficulty: "Medium", projectPhases: "Concept, Schematic, Construction", order: 1 },
            { id: "biodiversity", name: "Biodiversity Enhancement", category: "nature", shortDescription: "Ecological restoration", description: "Enhancing biodiversity on site.", aims: "", tips: "", required: false, maxPoints: 6, difficulty: "Medium", projectPhases: "Schematic, Design Dev, Documentation", order: 2 },
            { id: "nature-connectivity", name: "Nature Connectivity", category: "nature", shortDescription: "Green corridors", description: "Creating connections between natural areas.", aims: "", tips: "", required: false, maxPoints: 3, difficulty: "Medium", projectPhases: "Concept, Schematic, Design Dev", order: 3 },
            { id: "nature-steward", name: "Nature Stewardship", category: "nature", shortDescription: "Long-term nature care", description: "Long-term stewardship of natural areas.", aims: "", tips: "", required: false, maxPoints: 3, difficulty: "Medium", projectPhases: "Design Dev, Documentation, Handover", order: 4 },
            { id: "waterway", name: "Waterway Protection", category: "nature", shortDescription: "Stormwater management", description: "Protecting waterways from pollution.", aims: "", tips: "", required: false, maxPoints: 2, difficulty: "Medium", projectPhases: "Schematic, Design Dev, Documentation", order: 5 },
            // Leadership Category (2 credits)
            { id: "market-transform", name: "Market Transformation", category: "leadership", shortDescription: "Industry innovation", description: "Demonstrating leadership and innovation.", aims: "", tips: "", required: true, maxPoints: 2, difficulty: "Hard", projectPhases: "Concept, Schematic, Handover", order: 1 },
            { id: "leadership-challenge", name: "Leadership Challenges", category: "leadership", shortDescription: "Going beyond requirements", description: "Addressing leadership challenges and innovation.", aims: "", tips: "", required: false, maxPoints: 3, difficulty: "Hard", projectPhases: "Concept, Schematic, Handover", order: 2 },
        ];

        const defaultLevels = [
            // Industry Development
            { creditId: "ind-dev", level: "minimum", points: 0, summary: "No specific requirements", description: "No minimum expectation for this credit" },
            { creditId: "ind-dev", level: "credit", points: 1, summary: "Training and events", description: "Team training and industry event participation" },
            { creditId: "ind-dev", level: "exceptional", points: 2, summary: "Leadership", description: "Multiple events and research contribution" },
            // Responsible Construction
            { creditId: "resp-const", level: "minimum", points: 0, summary: "Basic EMP", description: "Basic Environmental Management Plan" },
            { creditId: "resp-const", level: "credit", points: 3, summary: "80% waste diversion", description: "80% construction waste diverted from landfill" },
            { creditId: "resp-const", level: "exceptional", points: 5, summary: "95% waste diversion", description: "95% construction waste diverted from landfill" },
            // Clean Air
            { creditId: "clean-air", level: "minimum", points: 0, summary: "Code compliance", description: "Meet minimum ventilation rates per AS 1668.2" },
            { creditId: "clean-air", level: "credit", points: 4, summary: "Enhanced ventilation", description: "50% improvement on code minimum fresh air" },
            { creditId: "clean-air", level: "exceptional", points: 6, summary: "Premium air quality", description: "100% improvement plus air quality monitoring" },
            // Energy Source
            { creditId: "energy-source", level: "minimum", points: 0, summary: "Grid connection", description: "Standard grid electricity connection" },
            { creditId: "energy-source", level: "credit", points: 4, summary: "Partial renewable", description: "50% renewable energy" },
            { creditId: "energy-source", level: "exceptional", points: 6, summary: "100% renewable", description: "100% renewable energy or better" },
            // Energy Use
            { creditId: "energy-use", level: "minimum", points: 0, summary: "Code compliance", description: "Meet NCC Section J requirements" },
            { creditId: "energy-use", level: "credit", points: 6, summary: "30% improvement", description: "30% improvement on reference building" },
            { creditId: "energy-use", level: "exceptional", points: 10, summary: "Net zero ready", description: "50%+ improvement, net zero carbon ready" },
            // Upfront Carbon Reduction
            { creditId: "upfront-carbon-red", level: "minimum", points: 0, summary: "LCA completed", description: "Life Cycle Assessment completed" },
            { creditId: "upfront-carbon-red", level: "credit", points: 6, summary: "20% reduction", description: "20% reduction in upfront carbon" },
            { creditId: "upfront-carbon-red", level: "exceptional", points: 10, summary: "40%+ reduction", description: "40%+ reduction in upfront carbon" },
        ];

        const defaultCriteria = [
            // Responsible Construction
            { creditId: "resp-const", level: "minimum", criteriaNum: 1, text: "Complete an Environmental Management Plan (EMP)", mandatory: true, evidenceType: "Document" },
            { creditId: "resp-const", level: "minimum", criteriaNum: 2, text: "Implement waste management procedures", mandatory: true, evidenceType: "Document" },
            { creditId: "resp-const", level: "credit", criteriaNum: 1, text: "Achieve 80% construction waste diversion from landfill", mandatory: true, evidenceType: "Report" },
            { creditId: "resp-const", level: "exceptional", criteriaNum: 1, text: "Achieve 95% construction waste diversion", mandatory: true, evidenceType: "Report" },
            // Clean Air
            { creditId: "clean-air", level: "minimum", criteriaNum: 1, text: "Meet minimum ventilation rates per AS 1668.2", mandatory: true, evidenceType: "Calculation" },
            { creditId: "clean-air", level: "credit", criteriaNum: 1, text: "Provide 50% more fresh air than code minimum", mandatory: true, evidenceType: "Calculation" },
            { creditId: "clean-air", level: "exceptional", criteriaNum: 1, text: "Provide 100% more fresh air than code minimum", mandatory: true, evidenceType: "Calculation" },
            // Energy Source
            { creditId: "energy-source", level: "minimum", criteriaNum: 1, text: "Demonstrate compliance with NCC energy requirements", mandatory: true, evidenceType: "Calculation" },
            { creditId: "energy-source", level: "credit", criteriaNum: 1, text: "50% of energy from renewable sources", mandatory: true, evidenceType: "Report" },
            { creditId: "energy-source", level: "exceptional", criteriaNum: 1, text: "100% of energy from renewable sources", mandatory: true, evidenceType: "Report" },
        ];

        const defaultDocumentation = [
            // Responsible Construction
            { creditId: "resp-const", level: "all", name: "Environmental Management Plan", type: "Report", description: "Comprehensive EMP covering construction phase", templateAvailable: true, templateLink: "templates/EMP_template.docx" },
            { creditId: "resp-const", level: "all", name: "Waste Management Report", type: "Report", description: "Monthly waste tracking and diversion rates", templateAvailable: true, templateLink: "templates/waste_report.xlsx" },
            // Clean Air
            { creditId: "clean-air", level: "all", name: "Ventilation Calculations", type: "Calculation", description: "Fresh air rates per AS 1668.2", templateAvailable: true, templateLink: "templates/ventilation_calc.xlsx" },
            { creditId: "clean-air", level: "all", name: "HVAC Design Report", type: "Report", description: "Mechanical ventilation system design", templateAvailable: false, templateLink: "" },
            // Energy Source
            { creditId: "energy-source", level: "all", name: "Energy Source Report", type: "Report", description: "Documentation of renewable energy systems", templateAvailable: false, templateLink: "" },
            // Energy Use
            { creditId: "energy-use", level: "all", name: "Energy Model Report", type: "Calculation", description: "Building energy modelling results", templateAvailable: false, templateLink: "" },
            // Upfront Carbon
            { creditId: "upfront-carbon-red", level: "all", name: "Life Cycle Assessment", type: "Calculation", description: "Whole building LCA report", templateAvailable: false, templateLink: "" },
        ];

        const defaultTemplates = [
            { id: "tpl-office-5", name: "Commercial Office - 5 Star", type: "Office", description: "Standard commercial office targeting 5 Star rating", targetRating: "5 Star", credits: "ind-dev,resp-const,clean-air,light-quality,energy-source,energy-use,upfront-carbon-red,movement,market-transform", active: true },
            { id: "tpl-office-6", name: "Premium Office - 6 Star", type: "Office", description: "Premium office development targeting 6 Star", targetRating: "6 Star", credits: "ind-dev,resp-const,verify-hand,resp-struct,clean-air,light-quality,acoustic,climate-res,energy-source,energy-use,upfront-carbon-red,movement,enjoyable,inclusive-const,impacts-nature,market-transform,leadership-challenge", active: true },
            { id: "tpl-resi-5", name: "Residential - 5 Star", type: "Residential", description: "Multi-residential building targeting 5 Star", targetRating: "5 Star", credits: "resp-const,clean-air,light-quality,amenity,nature-conn,energy-source,energy-use,upfront-carbon-red,water-use,enjoyable,design-equity", active: true },
            { id: "tpl-education-5", name: "Education - 5 Star", type: "Education", description: "School or university building targeting 5 Star", targetRating: "5 Star", credits: "resp-const,clean-air,light-quality,acoustic,amenity,nature-conn,energy-source,energy-use,movement,enjoyable,contribution,design-equity", active: true },
            { id: "tpl-healthcare-5", name: "Healthcare - 5 Star", type: "Healthcare", description: "Hospital or healthcare facility targeting 5 Star", targetRating: "5 Star", credits: "resp-const,verify-hand,clean-air,light-quality,acoustic,toxins,climate-res,ops-res,energy-source,energy-use,water-use,design-equity", active: true },
        ];

        const defaultSynergies = [
            { id: "syn-001", credit1: "energy-source", credit2: "energy-use", type: "Strong", description: "Energy source and energy use are directly related", recommendation: "Pursuing both credits together maximizes energy strategy effectiveness" },
            { id: "syn-002", credit1: "energy-use", credit2: "upfront-carbon-red", type: "Strong", description: "Energy efficiency reduces both operational and embodied carbon", recommendation: "Consider holistic carbon strategy addressing both credits" },
            { id: "syn-003", credit1: "clean-air", credit2: "light-quality", type: "Moderate", description: "Ventilation strategy affects both air quality and lighting comfort", recommendation: "Coordinate HVAC and lighting design" },
            { id: "syn-004", credit1: "resp-struct", credit2: "upfront-carbon-red", type: "Strong", description: "Structural materials have major impact on embodied carbon", recommendation: "Select low-carbon structural systems early in design" },
            { id: "syn-005", credit1: "climate-res", credit2: "heat-res", type: "Strong", description: "Climate and heat resilience share adaptation strategies", recommendation: "Develop integrated climate adaptation plan" },
            { id: "syn-006", credit1: "biodiversity", credit2: "nature-connectivity", type: "Strong", description: "Biodiversity enhancement supports nature connectivity", recommendation: "Plan landscape for both biodiversity and connectivity" },
            { id: "syn-007", credit1: "ind-dev", credit2: "market-transform", type: "Moderate", description: "Industry development contributes to market transformation", recommendation: "Document industry contributions for both credits" },
            { id: "syn-008", credit1: "movement", credit2: "low-emissions", type: "Strong", description: "Sustainable transport and EV charging are complementary", recommendation: "Develop integrated transport strategy" },
        ];

        const defaultCalculators = [
            { id: "responsible-products", name: "Responsible Products Calculator", description: "Calculate responsible products percentage", icon: "fa-boxes-stacked", type: "products", active: true },
            { id: "energy-reference", name: "Energy Use - Reference Pathway", description: "Calculate energy reduction vs reference", icon: "fa-bolt", type: "energy", active: true },
            { id: "upfront-carbon", name: "Upfront Carbon Emissions", description: "Calculate embodied carbon emissions", icon: "fa-cloud", type: "carbon", active: true },
            { id: "carbon-compensation", name: "Upfront Carbon Compensation", description: "Calculate carbon offset requirements", icon: "fa-leaf", type: "carbon", active: true },
            { id: "refrigerant", name: "Refrigerant Systems GWP", description: "Calculate refrigerant GWP impact", icon: "fa-snowflake", type: "energy", active: true },
            { id: "water", name: "Water Use Calculator", description: "Calculate water consumption reduction", icon: "fa-droplet", type: "water", active: true },
            { id: "movement", name: "Movement and Place", description: "Calculate transport impact score", icon: "fa-person-walking", type: "transport", active: true },
            { id: "procurement", name: "Procurement and Workforce", description: "Calculate social procurement spend", icon: "fa-handshake", type: "social", active: true },
            { id: "biodiversity", name: "Biodiversity Enhancement", description: "Calculate biodiversity net gain", icon: "fa-tree", type: "biodiversity", active: true },
        ];

        const defaultCommonMistakes = [
            { id: "cm-001", creditId: "energy-use", mistake: "Not engaging energy modeler early enough", impact: "High", prevention: "Engage NatHERS/Section J assessor at concept design" },
            { id: "cm-002", creditId: "upfront-carbon-red", mistake: "Missing LCA consultant in early design", impact: "High", prevention: "Appoint LCA consultant before schematic design" },
            { id: "cm-003", creditId: "clean-air", mistake: "Inadequate outdoor air rates in mechanical design", impact: "Medium", prevention: "Specify minimum outdoor air rates in brief" },
            { id: "cm-004", creditId: "resp-const", mistake: "Late engagement with contractor on EMP", impact: "Medium", prevention: "Include EMP requirements in tender documents" },
            { id: "cm-005", creditId: "movement", mistake: "Not completing transport assessment early", impact: "High", prevention: "Commission transport assessment at site selection" },
            { id: "cm-006", creditId: "light-quality", mistake: "Insufficient daylight modeling", impact: "Medium", prevention: "Model daylight at concept stage before fixing facades" },
            { id: "cm-007", creditId: "water-use", mistake: "Not considering rainwater harvesting potential", impact: "Medium", prevention: "Assess rainwater potential early in hydraulic design" },
            { id: "cm-008", creditId: "climate-res", mistake: "Incomplete climate risk assessment", impact: "High", prevention: "Commission climate risk study in early design" },
        ];

        // ============================================================
        // COMPONENTS
        // ============================================================

        // Sidebar Navigation
        function Sidebar({ activeTab, setActiveTab, dataStats, onLogout }) {
            const navItems = [
                { id: 'dashboard', icon: 'fa-chart-pie', label: 'Dashboard' },
                { id: 'categories', icon: 'fa-folder', label: 'Categories', count: dataStats.categories },
                { id: 'credits', icon: 'fa-star', label: 'Credits', count: dataStats.credits },
                { id: 'levels', icon: 'fa-layer-group', label: 'Levels', count: dataStats.levels },
                { id: 'criteria', icon: 'fa-list-check', label: 'Criteria', count: dataStats.criteria },
                { id: 'documentation', icon: 'fa-file-lines', label: 'Documentation', count: dataStats.documentation },
                { id: 'templates', icon: 'fa-copy', label: 'Templates', count: dataStats.templates },
                { id: 'synergies', icon: 'fa-link', label: 'Synergies', count: dataStats.synergies },
                { id: 'calculators', icon: 'fa-calculator', label: 'Calculators', count: dataStats.calculators },
                { id: 'mistakes', icon: 'fa-triangle-exclamation', label: 'Common Mistakes', count: dataStats.mistakes },
            ];

            return (
                <aside className="w-64 bg-white border-r border-gray-200 min-h-screen flex flex-col">
                    {/* Logo */}
                    <div className="p-6 border-b border-gray-200">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center">
                                <i className="fa-solid fa-leaf text-white"></i>
                            </div>
                            <div>
                                <h1 className="font-display font-bold text-gray-800">Green Star</h1>
                                <p className="text-xs text-gray-500">Admin Panel</p>
                            </div>
                        </div>
                    </div>

                    {/* Navigation */}
                    <nav className="flex-1 p-4">
                        <ul className="space-y-1">
                            {navItems.map(item => (
                                <li key={item.id}>
                                    <button
                                        onClick={() => setActiveTab(item.id)}
                                        className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-all
                                            ${activeTab === item.id
                                                ? 'bg-green-50 text-green-700 border-l-4 border-green-500'
                                                : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
                                            }`}
                                    >
                                        <i className={`fa-solid ${item.icon} w-5`}></i>
                                        <span className="flex-1 text-left">{item.label}</span>
                                        {item.count !== undefined && (
                                            <span className={`px-2 py-0.5 rounded-full text-xs ${
                                                activeTab === item.id ? 'bg-green-200 text-green-800' : 'bg-gray-100 text-gray-600'
                                            }`}>
                                                {item.count}
                                            </span>
                                        )}
                                    </button>
                                </li>
                            ))}
                        </ul>
                    </nav>

                    {/* Footer */}
                    <div className="p-4 border-t border-gray-200 space-y-2">
                        <a
                            href="index.html"
                            className="flex items-center gap-2 px-4 py-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-all"
                        >
                            <i className="fa-solid fa-arrow-left w-5"></i>
                            Back to App
                        </a>
                        <button
                            onClick={onLogout}
                            className="w-full flex items-center gap-2 px-4 py-3 rounded-lg text-sm font-medium text-red-600 hover:bg-red-50 transition-all"
                        >
                            <i className="fa-solid fa-right-from-bracket w-5"></i>
                            Sign Out
                        </button>
                    </div>
                </aside>
            );
        }

        // Header with actions
        function Header({ title, subtitle, onImport, onExport, onSave, onUndo, onRedo, canUndo, canRedo }) {
            return (
                <header className="bg-white border-b border-gray-200 px-8 py-6">
                    <div className="flex items-center justify-between">
                        <div>
                            <h1 className="font-display text-2xl font-bold text-gray-800">{title}</h1>
                            {subtitle && <p className="text-gray-500 mt-1">{subtitle}</p>}
                        </div>
                        <div className="flex items-center gap-3">
                            {/* Undo/Redo buttons */}
                            <div className="flex items-center gap-1 mr-2 border-r border-gray-200 pr-4">
                                <button
                                    onClick={onUndo}
                                    disabled={!canUndo}
                                    className={`p-2 rounded-lg transition-all flex items-center gap-1 ${canUndo ? 'text-gray-700 hover:bg-gray-100' : 'text-gray-300 cursor-not-allowed'}`}
                                    title="Undo (Ctrl+Z)"
                                >
                                    <i className="fa-solid fa-undo"></i>
                                </button>
                                <button
                                    onClick={onRedo}
                                    disabled={!canRedo}
                                    className={`p-2 rounded-lg transition-all flex items-center gap-1 ${canRedo ? 'text-gray-700 hover:bg-gray-100' : 'text-gray-300 cursor-not-allowed'}`}
                                    title="Redo (Ctrl+Y)"
                                >
                                    <i className="fa-solid fa-redo"></i>
                                </button>
                            </div>
                            <button
                                onClick={onImport}
                                className="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-all flex items-center gap-2"
                            >
                                <i className="fa-solid fa-upload"></i>
                                Import Excel
                            </button>
                            <button
                                onClick={onExport}
                                className="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-all flex items-center gap-2"
                            >
                                <i className="fa-solid fa-download"></i>
                                Export Excel
                            </button>
                            <button
                                onClick={onSave}
                                className="px-4 py-2 bg-green-600 rounded-lg text-sm font-medium text-white hover:bg-green-700 transition-all flex items-center gap-2"
                            >
                                <i className="fa-solid fa-save"></i>
                                Save Changes
                            </button>
                        </div>
                    </div>
                </header>
            );
        }

        // Dashboard
        function Dashboard({ stats, onNavigate }) {
            const cards = [
                { id: 'categories', label: 'Categories', count: stats.categories, icon: 'fa-folder', color: 'blue', description: 'Main category groups' },
                { id: 'credits', label: 'Credits', count: stats.credits, icon: 'fa-star', color: 'green', description: 'Individual credits' },
                { id: 'levels', label: 'Performance Levels', count: stats.levels, icon: 'fa-layer-group', color: 'purple', description: 'Minimum/Credit/Exceptional' },
                { id: 'criteria', label: 'Criteria', count: stats.criteria, icon: 'fa-list-check', color: 'amber', description: 'Requirements per level' },
                { id: 'documentation', label: 'Documentation', count: stats.documentation, icon: 'fa-file-lines', color: 'cyan', description: 'Required documents' },
                { id: 'templates', label: 'Templates', count: stats.templates, icon: 'fa-copy', color: 'pink', description: 'Project templates' },
                { id: 'synergies', label: 'Synergies', count: stats.synergies, icon: 'fa-link', color: 'teal', description: 'Credit relationships' },
            ];

            const colorClasses = {
                blue: 'bg-blue-50 text-blue-600 border-blue-200',
                green: 'bg-green-50 text-green-600 border-green-200',
                purple: 'bg-purple-50 text-purple-600 border-purple-200',
                amber: 'bg-amber-50 text-amber-600 border-amber-200',
                cyan: 'bg-cyan-50 text-cyan-600 border-cyan-200',
                pink: 'bg-pink-50 text-pink-600 border-pink-200',
                teal: 'bg-teal-50 text-teal-600 border-teal-200',
            };

            return (
                <div className="p-8">
                    <div className="mb-8">
                        <h2 className="font-display text-xl font-bold text-gray-800 mb-2">Welcome to the Admin Panel</h2>
                        <p className="text-gray-500">Manage all Green Star credit data from one place. Click on any card to edit that section.</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {cards.map(card => (
                            <button
                                key={card.id}
                                onClick={() => onNavigate(card.id)}
                                className={`p-6 rounded-xl border-2 ${colorClasses[card.color]} hover:shadow-lg transition-all text-left group`}
                            >
                                <div className="flex items-start justify-between mb-4">
                                    <i className={`fa-solid ${card.icon} text-2xl`}></i>
                                    <span className="text-3xl font-bold">{card.count}</span>
                                </div>
                                <h3 className="font-semibold text-gray-800 mb-1">{card.label}</h3>
                                <p className="text-sm text-gray-500">{card.description}</p>
                                <div className="mt-4 flex items-center text-sm font-medium group-hover:translate-x-1 transition-transform">
                                    Edit <i className="fa-solid fa-arrow-right ml-2"></i>
                                </div>
                            </button>
                        ))}
                    </div>

                    {/* Quick Tips */}
                    <div className="mt-8 p-6 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-200">
                        <h3 className="font-semibold text-green-800 mb-3 flex items-center gap-2">
                            <i className="fa-solid fa-lightbulb"></i>
                            Quick Tips
                        </h3>
                        <ul className="text-sm text-green-700 space-y-2">
                            <li><i className="fa-solid fa-check mr-2"></i>Changes are saved to your browser's local storage automatically</li>
                            <li><i className="fa-solid fa-check mr-2"></i>Use "Export Excel" to download a spreadsheet backup</li>
                            <li><i className="fa-solid fa-check mr-2"></i>Use "Save Changes" to push updates to the main app</li>
                            <li><i className="fa-solid fa-check mr-2"></i>Credit IDs link data across tables - don't change existing IDs</li>
                        </ul>
                    </div>
                </div>
            );
        }

        // Generic Table Editor with Search and Bulk Edit
        function TableEditor({ data, columns, onUpdate, onAdd, onDelete, emptyRow }) {
            const [editingId, setEditingId] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedRows, setSelectedRows] = useState(new Set());
            const [showBulkEdit, setShowBulkEdit] = useState(false);
            const [bulkEditField, setBulkEditField] = useState('');
            const [bulkEditValue, setBulkEditValue] = useState('');

            // Filter data based on search query
            const filteredData = data.filter(row => {
                if (!searchQuery.trim()) return true;
                const query = searchQuery.toLowerCase();
                return columns.some(col => {
                    const value = row[col.key];
                    if (value === null || value === undefined) return false;
                    return String(value).toLowerCase().includes(query);
                });
            });

            // Get original indices for filtered data
            const filteredIndices = data.map((row, i) => ({ row, index: i }))
                .filter(({ row }) => {
                    if (!searchQuery.trim()) return true;
                    const query = searchQuery.toLowerCase();
                    return columns.some(col => {
                        const value = row[col.key];
                        if (value === null || value === undefined) return false;
                        return String(value).toLowerCase().includes(query);
                    });
                })
                .map(({ index }) => index);

            const handleChange = (index, field, value) => {
                const newData = [...data];
                newData[index] = { ...newData[index], [field]: value };
                onUpdate(newData);
            };

            const handleAdd = () => {
                onUpdate([...data, { ...emptyRow, _id: Date.now() }]);
            };

            const handleDelete = (index) => {
                if (confirm('Are you sure you want to delete this row?')) {
                    const newData = data.filter((_, i) => i !== index);
                    onUpdate(newData);
                }
            };

            const toggleRowSelection = (index) => {
                const newSelected = new Set(selectedRows);
                if (newSelected.has(index)) {
                    newSelected.delete(index);
                } else {
                    newSelected.add(index);
                }
                setSelectedRows(newSelected);
            };

            const selectAll = () => {
                if (selectedRows.size === filteredIndices.length) {
                    setSelectedRows(new Set());
                } else {
                    setSelectedRows(new Set(filteredIndices));
                }
            };

            const handleBulkEdit = () => {
                if (!bulkEditField || selectedRows.size === 0) return;
                const newData = [...data];
                selectedRows.forEach(index => {
                    const col = columns.find(c => c.key === bulkEditField);
                    let value = bulkEditValue;
                    if (col?.type === 'checkbox') {
                        value = bulkEditValue === 'true';
                    } else if (col?.type === 'number') {
                        value = parseInt(bulkEditValue) || 0;
                    }
                    newData[index] = { ...newData[index], [bulkEditField]: value };
                });
                onUpdate(newData);
                setShowBulkEdit(false);
                setBulkEditField('');
                setBulkEditValue('');
                setSelectedRows(new Set());
            };

            const handleBulkDelete = () => {
                if (selectedRows.size === 0) return;
                if (confirm(`Are you sure you want to delete ${selectedRows.size} rows?`)) {
                    const newData = data.filter((_, i) => !selectedRows.has(i));
                    onUpdate(newData);
                    setSelectedRows(new Set());
                }
            };

            return (
                <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
                    {/* Search and Bulk Actions Bar */}
                    <div className="p-4 border-b border-gray-200 bg-gray-50 flex flex-wrap items-center gap-3">
                        <div className="flex-1 min-w-[200px]">
                            <div className="relative">
                                <i className="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input
                                    type="text"
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    placeholder="Search in table..."
                                    className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                />
                                {searchQuery && (
                                    <button
                                        onClick={() => setSearchQuery('')}
                                        className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                                    >
                                        <i className="fa-solid fa-times"></i>
                                    </button>
                                )}
                            </div>
                        </div>
                        <div className="text-sm text-gray-500">
                            {searchQuery ? `${filteredData.length} of ${data.length} rows` : `${data.length} rows`}
                        </div>
                        {selectedRows.size > 0 && (
                            <div className="flex items-center gap-2">
                                <span className="text-sm text-green-600 font-medium">{selectedRows.size} selected</span>
                                <button
                                    onClick={() => setShowBulkEdit(!showBulkEdit)}
                                    className="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-200 transition-colors"
                                >
                                    <i className="fa-solid fa-edit mr-1"></i> Bulk Edit
                                </button>
                                <button
                                    onClick={handleBulkDelete}
                                    className="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-sm font-medium hover:bg-red-200 transition-colors"
                                >
                                    <i className="fa-solid fa-trash mr-1"></i> Delete
                                </button>
                            </div>
                        )}
                    </div>

                    {/* Bulk Edit Panel */}
                    {showBulkEdit && selectedRows.size > 0 && (
                        <div className="p-4 border-b border-gray-200 bg-blue-50 flex items-center gap-3">
                            <span className="text-sm font-medium text-gray-700">Bulk edit {selectedRows.size} rows:</span>
                            <select
                                value={bulkEditField}
                                onChange={(e) => setBulkEditField(e.target.value)}
                                className="px-3 py-1.5 border border-gray-300 rounded-lg text-sm"
                            >
                                <option value="">Select field...</option>
                                {columns.filter(c => c.type !== 'textarea').map(col => (
                                    <option key={col.key} value={col.key}>{col.label}</option>
                                ))}
                            </select>
                            {bulkEditField && (() => {
                                const col = columns.find(c => c.key === bulkEditField);
                                if (col?.type === 'select') {
                                    return (
                                        <select
                                            value={bulkEditValue}
                                            onChange={(e) => setBulkEditValue(e.target.value)}
                                            className="px-3 py-1.5 border border-gray-300 rounded-lg text-sm"
                                        >
                                            <option value="">Select value...</option>
                                            {col.options.map(opt => (
                                                <option key={opt.value || opt} value={opt.value || opt}>
                                                    {opt.label || opt}
                                                </option>
                                            ))}
                                        </select>
                                    );
                                } else if (col?.type === 'checkbox') {
                                    return (
                                        <select
                                            value={bulkEditValue}
                                            onChange={(e) => setBulkEditValue(e.target.value)}
                                            className="px-3 py-1.5 border border-gray-300 rounded-lg text-sm"
                                        >
                                            <option value="">Select...</option>
                                            <option value="true">Yes / Checked</option>
                                            <option value="false">No / Unchecked</option>
                                        </select>
                                    );
                                } else if (col?.type === 'number') {
                                    return (
                                        <input
                                            type="number"
                                            value={bulkEditValue}
                                            onChange={(e) => setBulkEditValue(e.target.value)}
                                            className="px-3 py-1.5 border border-gray-300 rounded-lg text-sm w-24"
                                            placeholder="Value"
                                        />
                                    );
                                } else {
                                    return (
                                        <input
                                            type="text"
                                            value={bulkEditValue}
                                            onChange={(e) => setBulkEditValue(e.target.value)}
                                            className="px-3 py-1.5 border border-gray-300 rounded-lg text-sm"
                                            placeholder="New value"
                                        />
                                    );
                                }
                            })()}
                            <button
                                onClick={handleBulkEdit}
                                disabled={!bulkEditField || !bulkEditValue}
                                className="px-4 py-1.5 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                Apply
                            </button>
                            <button
                                onClick={() => { setShowBulkEdit(false); setBulkEditField(''); setBulkEditValue(''); }}
                                className="px-3 py-1.5 text-gray-600 hover:text-gray-800"
                            >
                                Cancel
                            </button>
                        </div>
                    )}

                    <div className="overflow-x-auto max-h-[calc(100vh-380px)] overflow-y-auto">
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th style={{ width: '40px' }}>
                                        <input
                                            type="checkbox"
                                            checked={selectedRows.size === filteredIndices.length && filteredIndices.length > 0}
                                            onChange={selectAll}
                                            className="w-4 h-4 rounded border-gray-300 text-green-600 focus:ring-green-500"
                                        />
                                    </th>
                                    {columns.map(col => (
                                        <th key={col.key} style={{ width: col.width }}>{col.label}</th>
                                    ))}
                                    <th style={{ width: '80px' }}>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredIndices.map((originalIndex) => {
                                    const row = data[originalIndex];
                                    return (
                                    <tr key={row._id || row.id || originalIndex} className={`animate-fade-in ${selectedRows.has(originalIndex) ? 'bg-green-50' : ''}`}>
                                        <td>
                                            <input
                                                type="checkbox"
                                                checked={selectedRows.has(originalIndex)}
                                                onChange={() => toggleRowSelection(originalIndex)}
                                                className="w-4 h-4 rounded border-gray-300 text-green-600 focus:ring-green-500"
                                            />
                                        </td>
                                        {columns.map(col => (
                                            <td key={col.key}>
                                                {col.type === 'select' ? (
                                                    <select
                                                        value={row[col.key] || ''}
                                                        onChange={(e) => handleChange(originalIndex, col.key, e.target.value)}
                                                    >
                                                        <option value="">Select...</option>
                                                        {col.options.map(opt => (
                                                            <option key={opt.value || opt} value={opt.value || opt}>
                                                                {opt.label || opt}
                                                            </option>
                                                        ))}
                                                    </select>
                                                ) : col.type === 'checkbox' ? (
                                                    <input
                                                        type="checkbox"
                                                        checked={row[col.key] || false}
                                                        onChange={(e) => handleChange(originalIndex, col.key, e.target.checked)}
                                                        className="w-5 h-5 rounded border-gray-300 text-green-600 focus:ring-green-500"
                                                    />
                                                ) : col.type === 'textarea' ? (
                                                    <textarea
                                                        value={row[col.key] || ''}
                                                        onChange={(e) => handleChange(originalIndex, col.key, e.target.value)}
                                                        rows={2}
                                                    />
                                                ) : col.type === 'number' ? (
                                                    <input
                                                        type="number"
                                                        value={row[col.key] || ''}
                                                        onChange={(e) => handleChange(originalIndex, col.key, parseInt(e.target.value) || 0)}
                                                        min={col.min || 0}
                                                        max={col.max}
                                                    />
                                                ) : (
                                                    <input
                                                        type="text"
                                                        value={row[col.key] || ''}
                                                        onChange={(e) => handleChange(originalIndex, col.key, e.target.value)}
                                                        placeholder={col.placeholder}
                                                    />
                                                )}
                                            </td>
                                        ))}
                                        <td>
                                            <button
                                                onClick={() => handleDelete(originalIndex)}
                                                className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                                                title="Delete row"
                                            >
                                                <i className="fa-solid fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <div className="p-4 border-t border-gray-200 bg-gray-50">
                        <button
                            onClick={handleAdd}
                            className="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-all flex items-center gap-2"
                        >
                            <i className="fa-solid fa-plus"></i>
                            Add New Row
                        </button>
                    </div>
                </div>
            );
        }

        // Categories Editor
        function CategoriesEditor({ data, onUpdate }) {
            const columns = [
                { key: 'id', label: 'ID', width: '120px', placeholder: 'e.g., responsible' },
                { key: 'name', label: 'Name', width: '150px', placeholder: 'e.g., Responsible' },
                { key: 'description', label: 'Description', type: 'textarea', width: '300px' },
                { key: 'icon', label: 'Icon', width: '150px', placeholder: 'fa-shield-halved' },
                { key: 'color', label: 'Color', type: 'select', width: '120px', options: ['amber', 'green', 'blue', 'red', 'purple', 'pink', 'emerald', 'indigo', 'cyan', 'teal'] },
                { key: 'order', label: 'Order', type: 'number', width: '80px', min: 1 },
            ];

            const emptyRow = { id: '', name: '', description: '', icon: 'fa-folder', color: 'gray', order: data.length + 1 };

            return (
                <div className="p-8">
                    <div className="mb-6">
                        <h2 className="font-display text-xl font-bold text-gray-800 mb-2">Categories</h2>
                        <p className="text-gray-500">Manage the 8 main category groups. Icon names are from Font Awesome (fa-xxx).</p>
                    </div>
                    <TableEditor data={data} columns={columns} onUpdate={onUpdate} emptyRow={emptyRow} />
                </div>
            );
        }

        // Credits Editor
        function CreditsEditor({ data, onUpdate, categories }) {
            const categoryOptions = categories.map(c => ({ value: c.id, label: c.name }));
            const difficultyOptions = ['Easy', 'Medium', 'Hard'];
            const phaseOptions = ['Concept', 'Schematic', 'Design Dev', 'Documentation', 'Construction', 'Handover'];

            const columns = [
                { key: 'id', label: 'Credit ID', width: '100px', placeholder: 'e.g., resp-01' },
                { key: 'name', label: 'Credit Name', width: '180px' },
                { key: 'category', label: 'Category', type: 'select', width: '120px', options: categoryOptions },
                { key: 'shortDescription', label: 'Short Desc', width: '180px' },
                { key: 'description', label: 'Full Description', type: 'textarea', width: '250px' },
                { key: 'aims', label: 'Credit Aims', type: 'textarea', width: '200px' },
                { key: 'tips', label: 'Tips', type: 'textarea', width: '200px' },
                { key: 'required', label: 'Required?', type: 'checkbox', width: '70px' },
                { key: 'maxPoints', label: 'Max Pts', type: 'number', width: '70px', min: 0, max: 10 },
                { key: 'difficulty', label: 'Difficulty', type: 'select', width: '100px', options: difficultyOptions },
                { key: 'projectPhases', label: 'Project Phases', width: '180px', placeholder: 'Concept, Design Dev' },
                { key: 'order', label: 'Order', type: 'number', width: '60px', min: 1 },
            ];

            const emptyRow = { id: '', name: '', category: '', shortDescription: '', description: '', aims: '', tips: '', required: false, maxPoints: 2, difficulty: 'Medium', projectPhases: '', order: 1 };

            return (
                <div className="p-8">
                    <div className="mb-6">
                        <h2 className="font-display text-xl font-bold text-gray-800 mb-2">Credits</h2>
                        <p className="text-gray-500">Manage individual credits. Set difficulty to "Easy" for Quick Wins. Project phases are comma-separated.</p>
                    </div>
                    <TableEditor data={data} columns={columns} onUpdate={onUpdate} emptyRow={emptyRow} />
                </div>
            );
        }

        // Levels Editor
        function LevelsEditor({ data, onUpdate, credits }) {
            const creditOptions = credits.map(c => ({ value: c.id, label: `${c.id} - ${c.name}` }));
            const levelOptions = [
                { value: 'minimum', label: 'Minimum Expectation' },
                { value: 'credit', label: 'Credit Achievement' },
                { value: 'exceptional', label: 'Exceptional Performance' },
            ];

            const columns = [
                { key: 'creditId', label: 'Credit ID', type: 'select', width: '200px', options: creditOptions },
                { key: 'level', label: 'Level', type: 'select', width: '180px', options: levelOptions },
                { key: 'points', label: 'Points', type: 'number', width: '80px', min: 0, max: 10 },
                { key: 'summary', label: 'Summary', width: '200px' },
                { key: 'description', label: 'Description', type: 'textarea', width: '300px' },
            ];

            const emptyRow = { creditId: '', level: 'minimum', points: 0, summary: '', description: '' };

            return (
                <div className="p-8">
                    <div className="mb-6">
                        <h2 className="font-display text-xl font-bold text-gray-800 mb-2">Performance Levels</h2>
                        <p className="text-gray-500">Define Minimum, Credit, and Exceptional levels for each credit.</p>
                    </div>
                    <TableEditor data={data} columns={columns} onUpdate={onUpdate} emptyRow={emptyRow} />
                </div>
            );
        }

        // Criteria Editor
        function CriteriaEditor({ data, onUpdate, credits }) {
            const creditOptions = credits.map(c => ({ value: c.id, label: `${c.id} - ${c.name}` }));
            const levelOptions = [
                { value: 'minimum', label: 'Minimum Expectation' },
                { value: 'credit', label: 'Credit Achievement' },
                { value: 'exceptional', label: 'Exceptional Performance' },
            ];
            const evidenceOptions = ['Document', 'Calculation', 'Drawing', 'Report', 'Certificate', 'Photo', 'Declaration', 'Other'];

            const columns = [
                { key: 'creditId', label: 'Credit ID', type: 'select', width: '180px', options: creditOptions },
                { key: 'level', label: 'Level', type: 'select', width: '160px', options: levelOptions },
                { key: 'criteriaNum', label: '#', type: 'number', width: '60px', min: 1 },
                { key: 'text', label: 'Criteria Text', type: 'textarea', width: '350px' },
                { key: 'mandatory', label: 'Mandatory?', type: 'checkbox', width: '90px' },
                { key: 'evidenceType', label: 'Evidence', type: 'select', width: '120px', options: evidenceOptions },
            ];

            const emptyRow = { creditId: '', level: 'minimum', criteriaNum: 1, text: '', mandatory: true, evidenceType: 'Document' };

            return (
                <div className="p-8">
                    <div className="mb-6">
                        <h2 className="font-display text-xl font-bold text-gray-800 mb-2">Criteria</h2>
                        <p className="text-gray-500">Define requirements for each performance level. These appear in the Criteria tab.</p>
                    </div>
                    <TableEditor data={data} columns={columns} onUpdate={onUpdate} emptyRow={emptyRow} />
                </div>
            );
        }

        // Documentation Editor
        function DocumentationEditor({ data, onUpdate, credits }) {
            const creditOptions = credits.map(c => ({ value: c.id, label: `${c.id} - ${c.name}` }));
            const levelOptions = [
                { value: 'all', label: 'All Levels' },
                { value: 'minimum', label: 'Minimum Expectation' },
                { value: 'credit', label: 'Credit Achievement' },
                { value: 'exceptional', label: 'Exceptional Performance' },
            ];
            const docTypeOptions = ['Report', 'Calculation', 'Drawing', 'Certificate', 'Declaration', 'Photo Evidence', 'Specification', 'Contract', 'Other'];

            const columns = [
                { key: 'creditId', label: 'Credit ID', type: 'select', width: '180px', options: creditOptions },
                { key: 'level', label: 'Level', type: 'select', width: '150px', options: levelOptions },
                { key: 'name', label: 'Document Name', width: '200px' },
                { key: 'type', label: 'Type', type: 'select', width: '130px', options: docTypeOptions },
                { key: 'description', label: 'Description', type: 'textarea', width: '250px' },
                { key: 'templateAvailable', label: 'Template?', type: 'checkbox', width: '80px' },
                { key: 'templateLink', label: 'Template Link', width: '200px' },
            ];

            const emptyRow = { creditId: '', level: 'all', name: '', type: 'Document', description: '', templateAvailable: false, templateLink: '' };

            return (
                <div className="p-8">
                    <div className="mb-6">
                        <h2 className="font-display text-xl font-bold text-gray-800 mb-2">Documentation</h2>
                        <p className="text-gray-500">Define required documents for each credit. Optionally provide template links.</p>
                    </div>
                    <TableEditor data={data} columns={columns} onUpdate={onUpdate} emptyRow={emptyRow} />
                </div>
            );
        }

        // Templates Editor
        function TemplatesEditor({ data, onUpdate }) {
            const typeOptions = ['Office', 'Residential', 'Retail', 'Education', 'Healthcare', 'Industrial', 'Mixed Use', 'Other'];
            const ratingOptions = ['4 Star', '5 Star', '6 Star'];

            const columns = [
                { key: 'id', label: 'Template ID', width: '130px', placeholder: 'tpl-xxx' },
                { key: 'name', label: 'Template Name', width: '200px' },
                { key: 'type', label: 'Building Type', type: 'select', width: '130px', options: typeOptions },
                { key: 'description', label: 'Description', type: 'textarea', width: '250px' },
                { key: 'targetRating', label: 'Target', type: 'select', width: '100px', options: ratingOptions },
                { key: 'credits', label: 'Credits (comma-separated)', type: 'textarea', width: '250px' },
                { key: 'active', label: 'Active?', type: 'checkbox', width: '70px' },
            ];

            const emptyRow = { id: '', name: '', type: 'Office', description: '', targetRating: '5 Star', credits: '', active: true };

            return (
                <div className="p-8">
                    <div className="mb-6">
                        <h2 className="font-display text-xl font-bold text-gray-800 mb-2">Project Templates</h2>
                        <p className="text-gray-500">Pre-configured credit selections for different building types. List credit IDs separated by commas.</p>
                    </div>
                    <TableEditor data={data} columns={columns} onUpdate={onUpdate} emptyRow={emptyRow} />
                </div>
            );
        }

        // Synergies Editor
        function SynergiesEditor({ data, onUpdate, credits }) {
            const creditOptions = credits.map(c => ({ value: c.id, label: `${c.id} - ${c.name}` }));
            const typeOptions = ['Strong', 'Moderate', 'Documentation'];

            const columns = [
                { key: 'id', label: 'Synergy ID', width: '120px', placeholder: 'syn-xxx' },
                { key: 'credit1', label: 'Credit 1', type: 'select', width: '180px', options: creditOptions },
                { key: 'credit2', label: 'Credit 2', type: 'select', width: '180px', options: creditOptions },
                { key: 'type', label: 'Type', type: 'select', width: '120px', options: typeOptions },
                { key: 'description', label: 'Description', type: 'textarea', width: '250px' },
                { key: 'recommendation', label: 'Recommendation', type: 'textarea', width: '250px' },
            ];

            const emptyRow = { id: '', credit1: '', credit2: '', type: 'Moderate', description: '', recommendation: '' };

            return (
                <div className="p-8">
                    <div className="mb-6">
                        <h2 className="font-display text-xl font-bold text-gray-800 mb-2">Credit Synergies</h2>
                        <p className="text-gray-500">Define relationships between credits. Strong synergies are highlighted in the app.</p>
                    </div>
                    <TableEditor data={data} columns={columns} onUpdate={onUpdate} emptyRow={emptyRow} />
                </div>
            );
        }

        // Calculators Editor
        function CalculatorsEditor({ data, onUpdate }) {
            const typeOptions = ['products', 'energy', 'carbon', 'water', 'transport', 'social', 'biodiversity', 'other'];

            const columns = [
                { key: 'id', label: 'Calculator ID', width: '150px', placeholder: 'calculator-id' },
                { key: 'name', label: 'Calculator Name', width: '200px' },
                { key: 'description', label: 'Description', type: 'textarea', width: '250px' },
                { key: 'icon', label: 'Icon (FA)', width: '130px', placeholder: 'fa-calculator' },
                { key: 'type', label: 'Type', type: 'select', width: '120px', options: typeOptions },
                { key: 'active', label: 'Active?', type: 'checkbox', width: '70px' },
            ];

            const emptyRow = { id: '', name: '', description: '', icon: 'fa-calculator', type: 'other', active: true };

            return (
                <div className="p-8">
                    <div className="mb-6">
                        <h2 className="font-display text-xl font-bold text-gray-800 mb-2">Calculators</h2>
                        <p className="text-gray-500">Manage the calculators available in the main app. Use FontAwesome icon class names.</p>
                    </div>
                    <TableEditor data={data} columns={columns} onUpdate={onUpdate} emptyRow={emptyRow} />
                </div>
            );
        }

        // Common Mistakes Editor
        function CommonMistakesEditor({ data, onUpdate, credits }) {
            const creditOptions = credits.map(c => ({ value: c.id, label: `${c.id} - ${c.name}` }));
            const impactOptions = ['High', 'Medium', 'Low'];

            const columns = [
                { key: 'id', label: 'ID', width: '100px', placeholder: 'cm-xxx' },
                { key: 'creditId', label: 'Credit', type: 'select', width: '180px', options: creditOptions },
                { key: 'mistake', label: 'Common Mistake', type: 'textarea', width: '250px' },
                { key: 'impact', label: 'Impact', type: 'select', width: '100px', options: impactOptions },
                { key: 'prevention', label: 'Prevention Tip', type: 'textarea', width: '250px' },
            ];

            const emptyRow = { id: '', creditId: '', mistake: '', impact: 'Medium', prevention: '' };

            return (
                <div className="p-8">
                    <div className="mb-6">
                        <h2 className="font-display text-xl font-bold text-gray-800 mb-2">Common Mistakes</h2>
                        <p className="text-gray-500">Define common mistakes for each credit to help users avoid pitfalls during submission.</p>
                    </div>
                    <TableEditor data={data} columns={columns} onUpdate={onUpdate} emptyRow={emptyRow} />
                </div>
            );
        }

        // Import Modal
        function ImportModal({ isOpen, onClose, onImport }) {
            const [status, setStatus] = useState(null);
            const fileInputRef = React.useRef(null);

            if (!isOpen) return null;

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setStatus({ type: 'info', message: 'Reading file...' });

                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data, { type: 'array' });

                    const imported = {};

                    // Parse Categories
                    if (workbook.SheetNames.includes('Categories')) {
                        imported.categories = XLSX.utils.sheet_to_json(workbook.Sheets['Categories']).map(row => ({
                            id: row['Category ID'],
                            name: row['Category Name'],
                            description: row['Description'],
                            icon: row['Icon (FontAwesome)'],
                            color: row['Color Theme'],
                            order: row['Display Order'],
                        }));
                    }

                    // Parse Credits
                    if (workbook.SheetNames.includes('Credits')) {
                        imported.credits = XLSX.utils.sheet_to_json(workbook.Sheets['Credits']).map(row => ({
                            id: row['Credit ID'],
                            name: row['Credit Name'],
                            category: row['Category']?.toLowerCase(),
                            shortDescription: row['Short Description'],
                            description: row['Full Description'],
                            aims: row['Credit Aims'] || '',
                            tips: row['Tips'] || '',
                            required: row['Is Required?'] === 'Yes',
                            maxPoints: row['Max Points'],
                            difficulty: row['Difficulty (Easy/Medium/Hard)'] || 'Medium',
                            projectPhases: row['Project Phases'] || '',
                            order: row['Display Order'],
                        }));
                    }

                    // Parse Levels
                    if (workbook.SheetNames.includes('Levels')) {
                        imported.levels = XLSX.utils.sheet_to_json(workbook.Sheets['Levels']).map(row => ({
                            creditId: row['Credit ID'],
                            level: row['Level Type'] === 'Minimum Expectation' ? 'minimum' :
                                   row['Level Type'] === 'Credit Achievement' ? 'credit' : 'exceptional',
                            points: row['Points'],
                            summary: row['Summary'],
                            description: row['Description'],
                        }));
                    }

                    // Parse Criteria
                    if (workbook.SheetNames.includes('Criteria')) {
                        imported.criteria = XLSX.utils.sheet_to_json(workbook.Sheets['Criteria']).map(row => ({
                            creditId: row['Credit ID'],
                            level: row['Level Type'] === 'Minimum Expectation' ? 'minimum' :
                                   row['Level Type'] === 'Credit Achievement' ? 'credit' : 'exceptional',
                            criteriaNum: row['Criteria #'],
                            text: row['Criteria Text'],
                            mandatory: row['Is Mandatory?'] === 'Yes',
                            evidenceType: row['Evidence Type'],
                        }));
                    }

                    // Parse Documentation
                    if (workbook.SheetNames.includes('Documentation')) {
                        imported.documentation = XLSX.utils.sheet_to_json(workbook.Sheets['Documentation']).map(row => ({
                            creditId: row['Credit ID'],
                            level: row['Level Type'] === 'All Levels' ? 'all' :
                                   row['Level Type'] === 'Minimum Expectation' ? 'minimum' :
                                   row['Level Type'] === 'Credit Achievement' ? 'credit' : 'exceptional',
                            name: row['Document Name'],
                            type: row['Document Type'],
                            description: row['Description'],
                            templateAvailable: row['Template Available?'] === 'Yes',
                            templateLink: row['Template Link'],
                        }));
                    }

                    // Parse Templates
                    if (workbook.SheetNames.includes('Templates')) {
                        imported.templates = XLSX.utils.sheet_to_json(workbook.Sheets['Templates']).map(row => ({
                            id: row['Template ID'],
                            name: row['Template Name'],
                            type: row['Building Type'],
                            description: row['Description'],
                            targetRating: row['Target Star Rating'],
                            credits: row['Recommended Credits (comma-separated)'],
                            active: row['Is Active?'] === 'Yes',
                        }));
                    }

                    // Parse Synergies
                    if (workbook.SheetNames.includes('Synergies')) {
                        imported.synergies = XLSX.utils.sheet_to_json(workbook.Sheets['Synergies']).map(row => ({
                            id: row['Synergy ID'],
                            credit1: row['Credit 1'],
                            credit2: row['Credit 2'],
                            type: row['Synergy Type'],
                            description: row['Description'],
                            recommendation: row['Recommendation'],
                        }));
                    }

                    // Parse Calculators
                    if (workbook.SheetNames.includes('Calculators')) {
                        imported.calculators = XLSX.utils.sheet_to_json(workbook.Sheets['Calculators']).map(row => ({
                            id: row['Calculator ID'],
                            name: row['Calculator Name'],
                            description: row['Description'],
                            icon: row['Icon (FontAwesome)'],
                            type: row['Type'],
                            active: row['Is Active?'] === 'Yes',
                        }));
                    }

                    // Parse Common Mistakes
                    if (workbook.SheetNames.includes('CommonMistakes')) {
                        imported.commonMistakes = XLSX.utils.sheet_to_json(workbook.Sheets['CommonMistakes']).map(row => ({
                            id: row['Mistake ID'],
                            creditId: row['Credit ID'],
                            mistake: row['Common Mistake'],
                            impact: row['Impact Level'],
                            prevention: row['Prevention Tip'],
                        }));
                    }

                    onImport(imported);
                    setStatus({ type: 'success', message: 'Import successful!' });
                    setTimeout(() => onClose(), 1000);
                } catch (error) {
                    setStatus({ type: 'error', message: `Error: ${error.message}` });
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onClick={onClose}>
                    <div className="bg-white rounded-2xl p-6 max-w-md w-full" onClick={e => e.stopPropagation()}>
                        <h2 className="font-display text-xl font-bold text-gray-800 mb-4">Import from Excel</h2>
                        <p className="text-gray-600 mb-6">Upload an Excel file to import data. This will replace existing data.</p>

                        <input
                            ref={fileInputRef}
                            type="file"
                            accept=".xlsx,.xls"
                            onChange={handleFileUpload}
                            className="hidden"
                        />

                        <button
                            onClick={() => fileInputRef.current?.click()}
                            className="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl hover:border-green-500 transition-colors flex flex-col items-center gap-2 text-gray-500 hover:text-green-600"
                        >
                            <i className="fa-solid fa-cloud-arrow-up text-3xl"></i>
                            <span>Click to upload Excel file</span>
                        </button>

                        {status && (
                            <div className={`mt-4 p-3 rounded-lg text-sm ${
                                status.type === 'success' ? 'bg-green-100 text-green-700' :
                                status.type === 'error' ? 'bg-red-100 text-red-700' :
                                'bg-blue-100 text-blue-700'
                            }`}>
                                {status.message}
                            </div>
                        )}

                        <button
                            onClick={onClose}
                            className="w-full mt-4 py-2 text-gray-600 hover:text-gray-800"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            );
        }

        // Toast notification
        function Toast({ message, type, onClose }) {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, []);

            return (
                <div className={`fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white animate-fade-in ${
                    type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
                }`}>
                    <div className="flex items-center gap-3">
                        <i className={`fa-solid ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}`}></i>
                        {message}
                    </div>
                </div>
            );
        }

        // ============================================================
        // MAIN APP
        // ============================================================
        function App() {
            const [isAuthenticated, setIsAuthenticated] = useState(() => isSessionValid());
            const [activeTab, setActiveTab] = useState('dashboard');
            const [showImportModal, setShowImportModal] = useState(false);
            const [toast, setToast] = useState(null);

            // Handle logout
            const handleLogout = () => {
                endSession();
                setIsAuthenticated(false);
            };

            // Show login screen if not authenticated
            if (!isAuthenticated) {
                return <LoginScreen onLogin={() => setIsAuthenticated(true)} />;
            }

            // Data state
            const [categories, setCategories] = useState(() => {
                const saved = localStorage.getItem('admin_categories');
                return saved ? JSON.parse(saved) : defaultCategories;
            });
            const [credits, setCredits] = useState(() => {
                const saved = localStorage.getItem('admin_credits');
                return saved ? JSON.parse(saved) : defaultCredits;
            });
            const [levels, setLevels] = useState(() => {
                const saved = localStorage.getItem('admin_levels');
                return saved ? JSON.parse(saved) : defaultLevels;
            });
            const [criteria, setCriteria] = useState(() => {
                const saved = localStorage.getItem('admin_criteria');
                return saved ? JSON.parse(saved) : defaultCriteria;
            });
            const [documentation, setDocumentation] = useState(() => {
                const saved = localStorage.getItem('admin_documentation');
                return saved ? JSON.parse(saved) : defaultDocumentation;
            });
            const [templates, setTemplates] = useState(() => {
                const saved = localStorage.getItem('admin_templates');
                return saved ? JSON.parse(saved) : defaultTemplates;
            });
            const [synergies, setSynergies] = useState(() => {
                const saved = localStorage.getItem('admin_synergies');
                return saved ? JSON.parse(saved) : defaultSynergies;
            });
            const [calculators, setCalculators] = useState(() => {
                const saved = localStorage.getItem('admin_calculators');
                return saved ? JSON.parse(saved) : defaultCalculators;
            });
            const [commonMistakes, setCommonMistakes] = useState(() => {
                const saved = localStorage.getItem('admin_mistakes');
                return saved ? JSON.parse(saved) : defaultCommonMistakes;
            });

            // Undo/Redo history
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const isUndoRedo = React.useRef(false);

            // Get current state snapshot
            const getSnapshot = () => ({
                categories, credits, levels, criteria, documentation, templates, synergies, calculators, commonMistakes
            });

            // Record history (debounced to avoid too many entries)
            const recordHistory = React.useCallback(() => {
                if (isUndoRedo.current) return;

                setHistory(prev => {
                    const newHistory = prev.slice(0, historyIndex + 1);
                    newHistory.push(getSnapshot());
                    // Keep max 50 history entries
                    if (newHistory.length > 50) newHistory.shift();
                    return newHistory;
                });
                setHistoryIndex(prev => Math.min(prev + 1, 49));
            }, [categories, credits, levels, criteria, documentation, templates, synergies, calculators, commonMistakes, historyIndex]);

            // Track changes and record history with debounce
            const historyTimeout = React.useRef(null);
            useEffect(() => {
                if (isUndoRedo.current) {
                    isUndoRedo.current = false;
                    return;
                }

                if (historyTimeout.current) clearTimeout(historyTimeout.current);
                historyTimeout.current = setTimeout(recordHistory, 500);

                return () => {
                    if (historyTimeout.current) clearTimeout(historyTimeout.current);
                };
            }, [categories, credits, levels, criteria, documentation, templates, synergies, calculators, commonMistakes]);

            // Undo function
            const handleUndo = () => {
                if (historyIndex <= 0) return;

                const prevState = history[historyIndex - 1];
                if (!prevState) return;

                isUndoRedo.current = true;
                setCategories(prevState.categories);
                setCredits(prevState.credits);
                setLevels(prevState.levels);
                setCriteria(prevState.criteria);
                setDocumentation(prevState.documentation);
                setTemplates(prevState.templates);
                setSynergies(prevState.synergies);
                setCalculators(prevState.calculators);
                setCommonMistakes(prevState.commonMistakes);
                setHistoryIndex(historyIndex - 1);
                setToast({ message: 'Undone', type: 'info' });
            };

            // Redo function
            const handleRedo = () => {
                if (historyIndex >= history.length - 1) return;

                const nextState = history[historyIndex + 1];
                if (!nextState) return;

                isUndoRedo.current = true;
                setCategories(nextState.categories);
                setCredits(nextState.credits);
                setLevels(nextState.levels);
                setCriteria(nextState.criteria);
                setDocumentation(nextState.documentation);
                setTemplates(nextState.templates);
                setSynergies(nextState.synergies);
                setCalculators(nextState.calculators);
                setCommonMistakes(nextState.commonMistakes);
                setHistoryIndex(historyIndex + 1);
                setToast({ message: 'Redone', type: 'info' });
            };

            // Keyboard shortcuts for undo/redo
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                        e.preventDefault();
                        if (e.shiftKey) {
                            handleRedo();
                        } else {
                            handleUndo();
                        }
                    }
                    if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                        e.preventDefault();
                        handleRedo();
                    }
                };

                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [historyIndex, history]);

            const canUndo = historyIndex > 0;
            const canRedo = historyIndex < history.length - 1;

            // Auto-save to localStorage
            useEffect(() => {
                localStorage.setItem('admin_categories', JSON.stringify(categories));
            }, [categories]);
            useEffect(() => {
                localStorage.setItem('admin_credits', JSON.stringify(credits));
            }, [credits]);
            useEffect(() => {
                localStorage.setItem('admin_levels', JSON.stringify(levels));
            }, [levels]);
            useEffect(() => {
                localStorage.setItem('admin_criteria', JSON.stringify(criteria));
            }, [criteria]);
            useEffect(() => {
                localStorage.setItem('admin_documentation', JSON.stringify(documentation));
            }, [documentation]);
            useEffect(() => {
                localStorage.setItem('admin_templates', JSON.stringify(templates));
            }, [templates]);
            useEffect(() => {
                localStorage.setItem('admin_synergies', JSON.stringify(synergies));
            }, [synergies]);
            useEffect(() => {
                localStorage.setItem('admin_calculators', JSON.stringify(calculators));
            }, [calculators]);
            useEffect(() => {
                localStorage.setItem('admin_mistakes', JSON.stringify(commonMistakes));
            }, [commonMistakes]);

            const dataStats = {
                categories: categories.length,
                credits: credits.length,
                levels: levels.length,
                criteria: criteria.length,
                documentation: documentation.length,
                templates: templates.length,
                synergies: synergies.length,
                calculators: calculators.length,
                mistakes: commonMistakes.length,
            };

            const handleImport = (imported) => {
                if (imported.categories) setCategories(imported.categories);
                if (imported.credits) setCredits(imported.credits);
                if (imported.levels) setLevels(imported.levels);
                if (imported.criteria) setCriteria(imported.criteria);
                if (imported.documentation) setDocumentation(imported.documentation);
                if (imported.templates) setTemplates(imported.templates);
                if (imported.synergies) setSynergies(imported.synergies);
                if (imported.calculators) setCalculators(imported.calculators);
                if (imported.commonMistakes) setCommonMistakes(imported.commonMistakes);
                setToast({ message: 'Data imported successfully!', type: 'success' });
            };

            const handleExport = () => {
                const wb = XLSX.utils.book_new();

                // Categories sheet
                const catData = categories.map(c => ({
                    'Category ID': c.id,
                    'Category Name': c.name,
                    'Description': c.description,
                    'Icon (FontAwesome)': c.icon,
                    'Color Theme': c.color,
                    'Display Order': c.order,
                }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(catData), 'Categories');

                // Credits sheet
                const credData = credits.map(c => ({
                    'Credit ID': c.id,
                    'Credit Name': c.name,
                    'Category': c.category?.charAt(0).toUpperCase() + c.category?.slice(1),
                    'Short Description': c.shortDescription,
                    'Full Description': c.description,
                    'Credit Aims': c.aims || '',
                    'Tips': c.tips || '',
                    'Is Required?': c.required ? 'Yes' : 'No',
                    'Max Points': c.maxPoints,
                    'Difficulty (Easy/Medium/Hard)': c.difficulty || 'Medium',
                    'Project Phases': c.projectPhases || '',
                    'Display Order': c.order,
                }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(credData), 'Credits');

                // Levels sheet
                const levelData = levels.map(l => ({
                    'Credit ID': l.creditId,
                    'Level Type': l.level === 'minimum' ? 'Minimum Expectation' :
                                  l.level === 'credit' ? 'Credit Achievement' : 'Exceptional Performance',
                    'Points': l.points,
                    'Summary': l.summary,
                    'Description': l.description,
                }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(levelData), 'Levels');

                // Criteria sheet
                const critData = criteria.map(c => ({
                    'Credit ID': c.creditId,
                    'Level Type': c.level === 'minimum' ? 'Minimum Expectation' :
                                  c.level === 'credit' ? 'Credit Achievement' : 'Exceptional Performance',
                    'Criteria #': c.criteriaNum,
                    'Criteria Text': c.text,
                    'Is Mandatory?': c.mandatory ? 'Yes' : 'No',
                    'Evidence Type': c.evidenceType,
                }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(critData), 'Criteria');

                // Documentation sheet
                const docData = documentation.map(d => ({
                    'Credit ID': d.creditId,
                    'Level Type': d.level === 'all' ? 'All Levels' :
                                  d.level === 'minimum' ? 'Minimum Expectation' :
                                  d.level === 'credit' ? 'Credit Achievement' : 'Exceptional Performance',
                    'Document Name': d.name,
                    'Document Type': d.type,
                    'Description': d.description,
                    'Template Available?': d.templateAvailable ? 'Yes' : 'No',
                    'Template Link': d.templateLink,
                }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(docData), 'Documentation');

                // Templates sheet
                const tplData = templates.map(t => ({
                    'Template ID': t.id,
                    'Template Name': t.name,
                    'Building Type': t.type,
                    'Description': t.description,
                    'Target Star Rating': t.targetRating,
                    'Recommended Credits (comma-separated)': t.credits,
                    'Is Active?': t.active ? 'Yes' : 'No',
                }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(tplData), 'Templates');

                // Synergies sheet
                const synData = synergies.map(s => ({
                    'Synergy ID': s.id,
                    'Credit 1': s.credit1,
                    'Credit 2': s.credit2,
                    'Synergy Type': s.type,
                    'Description': s.description,
                    'Recommendation': s.recommendation,
                }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(synData), 'Synergies');

                // Calculators sheet
                const calcData = calculators.map(c => ({
                    'Calculator ID': c.id,
                    'Calculator Name': c.name,
                    'Description': c.description,
                    'Icon (FontAwesome)': c.icon,
                    'Type': c.type,
                    'Is Active?': c.active ? 'Yes' : 'No',
                }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(calcData), 'Calculators');

                // Common Mistakes sheet
                const mistakesData = commonMistakes.map(m => ({
                    'Mistake ID': m.id,
                    'Credit ID': m.creditId,
                    'Common Mistake': m.mistake,
                    'Impact Level': m.impact,
                    'Prevention Tip': m.prevention,
                }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mistakesData), 'CommonMistakes');

                // Save file
                XLSX.writeFile(wb, 'GreenStar_Admin_Data.xlsx');
                setToast({ message: 'Excel file downloaded!', type: 'success' });
            };

            const handleSave = () => {
                // Save to main app storage
                const appData = {
                    categories,
                    credits,
                    levels,
                    criteria,
                    documentation,
                    templates,
                    synergies,
                    calculators,
                    commonMistakes,
                    savedAt: new Date().toISOString(),
                };
                localStorage.setItem('greenstar_admin_data', JSON.stringify(appData));
                setToast({ message: 'Changes saved! Refresh the main app to see updates.', type: 'success' });
            };

            const renderContent = () => {
                switch (activeTab) {
                    case 'dashboard':
                        return <Dashboard stats={dataStats} onNavigate={setActiveTab} />;
                    case 'categories':
                        return <CategoriesEditor data={categories} onUpdate={setCategories} />;
                    case 'credits':
                        return <CreditsEditor data={credits} onUpdate={setCredits} categories={categories} />;
                    case 'levels':
                        return <LevelsEditor data={levels} onUpdate={setLevels} credits={credits} />;
                    case 'criteria':
                        return <CriteriaEditor data={criteria} onUpdate={setCriteria} credits={credits} />;
                    case 'documentation':
                        return <DocumentationEditor data={documentation} onUpdate={setDocumentation} credits={credits} />;
                    case 'templates':
                        return <TemplatesEditor data={templates} onUpdate={setTemplates} />;
                    case 'synergies':
                        return <SynergiesEditor data={synergies} onUpdate={setSynergies} credits={credits} />;
                    case 'calculators':
                        return <CalculatorsEditor data={calculators} onUpdate={setCalculators} />;
                    case 'mistakes':
                        return <CommonMistakesEditor data={commonMistakes} onUpdate={setCommonMistakes} credits={credits} />;
                    default:
                        return <Dashboard stats={dataStats} onNavigate={setActiveTab} />;
                }
            };

            const getPageTitle = () => {
                const titles = {
                    dashboard: { title: 'Dashboard', subtitle: 'Overview of all data' },
                    categories: { title: 'Categories', subtitle: 'Manage the 8 main category groups' },
                    credits: { title: 'Credits', subtitle: 'Manage individual credits' },
                    levels: { title: 'Performance Levels', subtitle: 'Define Minimum, Credit, and Exceptional levels' },
                    criteria: { title: 'Criteria', subtitle: 'Requirements for each level' },
                    documentation: { title: 'Documentation', subtitle: 'Required documents for each credit' },
                    templates: { title: 'Project Templates', subtitle: 'Pre-configured credit selections' },
                    synergies: { title: 'Credit Synergies', subtitle: 'Define credit relationships' },
                    calculators: { title: 'Calculators', subtitle: 'Manage calculators shown in the app' },
                    mistakes: { title: 'Common Mistakes', subtitle: 'Define common pitfalls for each credit' },
                };
                return titles[activeTab] || titles.dashboard;
            };

            const { title, subtitle } = getPageTitle();

            return (
                <div className="flex min-h-screen">
                    <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} dataStats={dataStats} onLogout={handleLogout} />
                    <main className="flex-1 bg-gray-50">
                        <Header
                            title={title}
                            subtitle={subtitle}
                            onImport={() => setShowImportModal(true)}
                            onExport={handleExport}
                            onSave={handleSave}
                            onUndo={handleUndo}
                            onRedo={handleRedo}
                            canUndo={canUndo}
                            canRedo={canRedo}
                        />
                        {renderContent()}
                    </main>

                    <ImportModal
                        isOpen={showImportModal}
                        onClose={() => setShowImportModal(false)}
                        onImport={handleImport}
                    />

                    {toast && (
                        <Toast
                            message={toast.message}
                            type={toast.type}
                            onClose={() => setToast(null)}
                        />
                    )}
                </div>
            );
        }

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
